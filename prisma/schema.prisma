// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  password  String
  rank      String?
  role      String?
  game      String?
  isPro     Boolean  @default(false)
  isAdmin   Boolean  @default(false)
  isOnline  Boolean  @default(false)
  lastSeen  DateTime @default(now())
  verified  Boolean  @default(false)
  bio       String?
  discord   String?
  steam     String?
  timezone  String?
  languages String @default("English")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())

  // Relations
  sessions        Session[]        @relation("ClientSessions")
  proSessions     Session[]        @relation("ProTeammateSessions")
  queueEntries    QueueEntry[]
  payments        Payment[]
  chatMessages    ChatMessage[]
  chatFiles       ChatFile[]
  messageReactions MessageReaction[]
  reviewsGiven    Review[]         @relation("Reviewer")
  reviewsReceived Review[]         @relation("Reviewed")
  discountCodeUsages DiscountCodeUsage[]
  authSessions    AuthSession[]
  createdDiscountCodes DiscountCode[] @relation("DiscountCodeCreator")
}

model Session {
  id            Int      @id @default(autoincrement())
  clientId      Int
  proTeammateId Int?
  game          String
  mode          String
  status        String   @default("Pending") // Pending, Active, Completed, Cancelled
  startTime     DateTime @default(now())
  endTime       DateTime?
  price         Float
  duration      Int      // in minutes
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  client        User     @relation("ClientSessions", fields: [clientId], references: [id])
  proTeammate   User?    @relation("ProTeammateSessions", fields: [proTeammateId], references: [id])
  chatMessages  ChatMessage[]
  chatFiles     ChatFile[]
  reviews       Review[]
}

model QueueEntry {
  id              Int      @id @default(autoincrement())
  userId          Int
  game            String
  gameMode        String
  numberOfMatches Int
  teammatesNeeded Int
  duration        Int      // in minutes
  pricePerMatch   Float
  totalPrice      Float
  status          String   @default("waiting") // waiting, matched, cancelled
  paymentStatus   String   @default("pending") // pending, paid, failed
  specialRequests String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id])
  payments        Payment[]
}

model Payment {
  id                    Int      @id @default(autoincrement())
  userId                Int
  queueEntryId          Int?
  amount                Float
  originalAmount        Float
  discountAmount        Float    @default(0)
  method                String   @default("stripe") // stripe, manual, paypal
  status                String   @default("pending") // pending, completed, failed, refunded
  stripePaymentIntentId String?
  discountCodeId        Int?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [userId], references: [id])
  queueEntry            QueueEntry? @relation(fields: [queueEntryId], references: [id])
  discountCode          DiscountCode? @relation(fields: [discountCodeId], references: [id])
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  sessionId Int
  senderId  Int
  content   String
  type      String   @default("text") // text, file, image, voice
  createdAt DateTime @default(now())

  // Relations
  session   Session  @relation(fields: [sessionId], references: [id])
  sender    User     @relation(fields: [senderId], references: [id])
  reactions MessageReaction[]
}

model ChatFile {
  id        Int      @id @default(autoincrement())
  sessionId Int
  uploadedBy Int
  fileName  String
  fileUrl   String
  fileSize  Int
  fileType  String
  createdAt DateTime @default(now())

  // Relations
  session   Session  @relation(fields: [sessionId], references: [id])
  uploader  User     @relation(fields: [uploadedBy], references: [id])
}

model MessageReaction {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  emoji     String
  createdAt DateTime @default(now())

  // Relations
  message   ChatMessage @relation(fields: [messageId], references: [id])
  user      User        @relation(fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
}

model Review {
  id            Int      @id @default(autoincrement())
  sessionId     Int
  reviewerId    Int
  reviewedId    Int
  rating        Int      // 1-5 stars
  comment       String?
  createdAt     DateTime @default(now())

  // Relations
  session       Session  @relation(fields: [sessionId], references: [id])
  reviewer      User     @relation("Reviewer", fields: [reviewerId], references: [id])
  reviewed      User     @relation("Reviewed", fields: [reviewedId], references: [id])
}

model DiscountCode {
  id             Int      @id @default(autoincrement())
  code           String   @unique
  discountType   String   // percentage, fixed, free
  discountValue  Float
  maxUses        Int?
  currentUses    Int      @default(0)
  validFrom      DateTime @default(now())
  validUntil     DateTime?
  isActive       Boolean  @default(true)
  minAmount      Float    @default(0)
  applicableGames String
  createdBy      Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  creator        User?    @relation("DiscountCodeCreator", fields: [createdBy], references: [id])
  payments       Payment[]
  usages         DiscountCodeUsage[]
}

model DiscountCodeUsage {
  id            Int      @id @default(autoincrement())
  discountCodeId Int
  userId        Int
  orderAmount   Float
  discountAmount Float
  usedAt        DateTime @default(now())

  // Relations
  discountCode  DiscountCode @relation(fields: [discountCodeId], references: [id])
  user          User         @relation(fields: [userId], references: [id])
}

model AuthSession {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id])
}